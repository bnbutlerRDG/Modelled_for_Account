-- Generate a range of dates from '2023-01-01' to the current date, truncated to the start of each month
WITH date_range AS (
  SELECT DATE_ADD(DATE('2023-01-01'), INTERVAL month MONTH) AS dpd_month
  FROM UNNEST(GENERATE_ARRAY(0, DATE_DIFF(CURRENT_DATE(), DATE('2023-01-01'), MONTH))) AS month
),

-- Calculate the monthly product counts for each organization
MonthlyProductCounts AS (
  SELECT `Organization Name` AS dpd_organization_name, 
         DATE_TRUNC(DATE(`Published Date`), MONTH) AS dpd_month,
         COUNT(DISTINCT `Data Product Code`) AS dpd_product_count
  FROM `rdmga4.RDMreports.Data Product Details Live`
  WHERE DATE(`Published Date`) >= DATE('2023-01-01')
    AND DATE(`Published Date`) < DATE_ADD(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 1 MONTH)
  GROUP BY `Organization Name`, dpd_month
),

-- Get a distinct list of organizations
AllOrganizationsMonths AS (
  SELECT DISTINCT dpd_organization_name
  FROM MonthlyProductCounts
),

-- Calculate cumulative product counts for each organization over time
CumulativeProductCounts AS (
  SELECT dpd_ao.dpd_organization_name, dpd_dr.dpd_month,
         COALESCE(dpd_mpc.dpd_product_count, 0) AS dpd_product_count,
         SUM(COALESCE(dpd_mpc.dpd_product_count, 0)) OVER (PARTITION BY dpd_ao.dpd_organization_name ORDER BY dpd_dr.dpd_month) AS dpd_cumulative_product_count
  FROM AllOrganizationsMonths dpd_ao
  CROSS JOIN date_range dpd_dr
  LEFT JOIN MonthlyProductCounts dpd_mpc ON dpd_ao.dpd_organization_name = dpd_mpc.dpd_organization_name AND dpd_dr.dpd_month = dpd_mpc.dpd_month
),

-- Calculate total cumulative product counts across all organizations for each month
TotalCumulativeProductCounts AS (
  SELECT dpd_month, 
         SUM(dpd_product_count) AS dpd_total_monthly_product_count,
         SUM(SUM(dpd_product_count)) OVER (ORDER BY dpd_month) AS dpd_total_cumulative_product_count
  FROM CumulativeProductCounts
  GROUP BY dpd_month
),

-- Calculate the percentage of total cumulative product count for each organization
PercentageCalculations AS (
  SELECT dpd_cpc.dpd_organization_name, dpd_cpc.dpd_month, dpd_cpc.dpd_product_count, dpd_cpc.dpd_cumulative_product_count,
         dpd_tcp.dpd_total_cumulative_product_count,
         ROUND(
           CASE 
             WHEN dpd_tcp.dpd_total_cumulative_product_count = 0 THEN 0
             ELSE (dpd_cpc.dpd_cumulative_product_count / dpd_tcp.dpd_total_cumulative_product_count) * 100
           END, 2) AS dpd_percentage_of_total
  FROM CumulativeProductCounts dpd_cpc
  JOIN TotalCumulativeProductCounts dpd_tcp ON dpd_cpc.dpd_month = dpd_tcp.dpd_month
),

-- Calculate the month-over-month percentage increase in cumulative product count for each organization
PercentageIncrease AS (
  SELECT dpd_pc.dpd_organization_name, dpd_pc.dpd_month, dpd_pc.dpd_product_count, dpd_pc.dpd_cumulative_product_count,
         LAG(dpd_pc.dpd_cumulative_product_count) OVER (PARTITION BY dpd_pc.dpd_organization_name ORDER BY dpd_pc.dpd_month) AS dpd_previous_cumulative_product_count,
         ROUND(
           CASE
             WHEN LAG(dpd_pc.dpd_cumulative_product_count) OVER (PARTITION BY dpd_pc.dpd_organization_name ORDER BY dpd_pc.dpd_month) = 0 THEN 0
             ELSE ((dpd_pc.dpd_cumulative_product_count - LAG(dpd_pc.dpd_cumulative_product_count) OVER (PARTITION BY dpd_pc.dpd_organization_name ORDER BY dpd_pc.dpd_month)) /
                   LAG(dpd_pc.dpd_cumulative_product_count) OVER (PARTITION BY dpd_pc.dpd_organization_name ORDER BY dpd_pc.dpd_month)) * 100
           END, 2) AS dpd_monthly_percentage_increase,
         ROUND(dpd_pc.dpd_percentage_of_total, 2) AS dpd_percentage_of_total
  FROM PercentageCalculations dpd_pc
)

-- Final select statement to get the desired fields with a unique ID
SELECT 
  ROW_NUMBER() OVER() AS dpd_id,  -- Generate a unique ID for each row
  dpd_organization_name, 
  dpd_month, 
  dpd_product_count, 
  dpd_cumulative_product_count,
  dpd_monthly_percentage_increase, 
  dpd_percentage_of_total
FROM PercentageIncrease
WHERE dpd_organization_name IS NOT NULL  -- Filter out rows with NULL organization name
ORDER BY dpd_organization_name, dpd_month;  -- Order the result by organization name and month
