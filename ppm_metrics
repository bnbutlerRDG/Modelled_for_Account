WITH monthly_dates AS (
    SELECT 
        CAST(FORMAT_DATE('%Y-%m-01', DATE(month_date)) AS DATE) AS month_date
    FROM 
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', CURRENT_DATE(), INTERVAL 1 MONTH)) AS month_date
)

SELECT 
    ROW_NUMBER() OVER() AS ppm_id,
    ro_seller.`Organization Name` AS ppm_publisher,
    ro_buyer.`Organization Name` AS ppm_consumer,
    c.`Data Product Name` AS ppm_data_product_name,
    md.month_date AS ppm_month,
    
    -- Active and Inactive Contracts
    COUNT(DISTINCT CASE 
        WHEN COALESCE(dc.`Total number of Hits`, 0) > 0 
             OR COALESCE(dc.`Total Volume Consumed in Bytes`, 0) > 0 
        THEN c.`Contract Code`
    END) AS ppm_active_contracts,
    COUNT(DISTINCT CASE 
        WHEN COALESCE(dc.`Total number of Hits`, 0) = 0 
             AND COALESCE(dc.`Total Volume Consumed in Bytes`, 0) = 0 
        THEN c.`Contract Code`
    END) AS ppm_inactive_contracts,

    -- Total API Calls and Volume
    SUM(COALESCE(dc.`Total number of Hits`, 0)) AS ppm_total_api_calls,
    SUM(COALESCE(dc.`Total Volume Consumed in Bytes`, 0)) AS ppm_total_volume,

    -- Total Subscribers
    COUNT(DISTINCT c.`Buyer BPID`) AS ppm_total_subscribers
FROM 
    monthly_dates AS md
LEFT JOIN 
    `rdmga4.RDMreports.contracts` AS c
ON 
    TRUE -- Keep all contracts regardless of date, as we are generating all months in `monthly_dates`
LEFT JOIN 
    `rdmga4.RDMreports.daily_consumption` AS dc
ON 
    c.`Contract Code` = dc.`Contract Code`
    AND DATE_TRUNC(dc.`Metrics Collection Date`, MONTH) = md.month_date
LEFT JOIN 
    `rdmga4.RDMreports.raw_organization_overview` AS ro_buyer
ON 
    CAST(c.`Buyer BPID` AS INT64) = ro_buyer.`BPID`
LEFT JOIN 
    `rdmga4.RDMreports.raw_organization_overview` AS ro_seller
ON 
    CAST(c.`Seller BPID` AS INT64) = ro_seller.`BPID`
WHERE 
    ro_buyer.`Organization Name` IS NOT NULL -- Exclude rows without valid buyer organizations
GROUP BY 
    ppm_publisher, ppm_consumer, ppm_data_product_name, ppm_month
ORDER BY 
    ppm_month, ppm_publisher, ppm_data_product_name, ppm_consumer;
