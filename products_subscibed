-- Extracts active contracts where the contract is currently valid
WITH active_contracts AS (
    SELECT 
        SAFE_CAST(`Buyer BPID` AS STRING) AS Consumer_BPID,  -- Convert BPID to STRING for proper joins
        `Data Product Code` AS Data_Product_Code,  -- Standardize column name for consistency
        `Contract Start Date` AS Contract_Start_Date,  -- Alias for readability
        `Contract Expiry Date` AS Contract_Expiry_Date  -- Alias for readability
    FROM `rdmga4.RDMreports.contracts`
    WHERE CURRENT_DATE BETWEEN `Contract Start Date` AND `Contract Expiry Date`  -- Only active contracts
),

-- Extracts consumer organization details from the raw organization overview table
consumer_info AS (
    SELECT 
        SAFE_CAST(BPID AS STRING) AS consumer_id,  -- Convert BPID to STRING to match contracts
        `Organization Name` AS consumer_name  -- Standardized alias for clarity
    FROM `rdmga4.RDMreports.raw_organization_overview`
),

-- Extracts product details for reference
product_info AS (
    SELECT 
        `Data Product Code` AS Data_Product_Code,  -- Standardized alias for consistency
        `Data Product Name` AS Data_Product_Name  -- Standardized alias for consistency
    FROM `rdmga4.RDMreports.raw_data_product_details`
)

-- Final selection: Combines active contracts, consumer details, and product details
SELECT 
    ci.consumer_id AS pds_consumer_id,  -- Unique identifier for consumer
    ci.consumer_name AS pds_consumer_name,  -- Name of the consumer organization
    ac.Data_Product_Code AS pds_data_product_code,  -- Unique product identifier
    pi.Data_Product_Name AS pds_data_product_name,  -- Name of the subscribed data product
    ac.Contract_Start_Date AS pds_contract_start_date,  -- Contract start date
    ac.Contract_Expiry_Date AS pds_contract_expiry_date  -- Contract expiry date
FROM active_contracts ac
JOIN consumer_info ci 
    ON ac.Consumer_BPID = ci.consumer_id  -- Match contracts with consumer details via BPID
JOIN product_info pi
    ON ac.Data_Product_Code = pi.Data_Product_Code;  -- Match contracts with product details

